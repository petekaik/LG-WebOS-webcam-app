<!--
Copyright (c) 2024 MorgeWeb

SPDX-License-Identifier: Apache-2.0
-->

<!DOCTYPE html>
<html>

<head>
	<title>Webcams</title>
	<style type="text/css">
		body {
			width: 100vw;
			height: 100vh;
			background: linear-gradient(135deg, #2a2a2a, #101010);
			margin: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			text-align: center;
			color: #FFFFFF;
		}

		div {
			width: 100%;
			height: 100%;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}

		h1 {
			position: absolute;
			top: 1em;
			left: 1em;
			color: #FFFFFF;
			font-size: 3vw;
			margin: 0;
		}

		#time {
			position: absolute;
			top: 1em;
			right: 1em;
			color: #FFFFFF;
			font-size: 3vw;
			margin: 0;
		}

		.video-container {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 1em;
			justify-content: center;
			align-items: center;
			margin: 2em auto;
			width: 90%;
			max-height: 80vh;
			overflow: hidden;
		}

		.grid-video {
			aspect-ratio: 16 / 9;
			object-fit: cover;
		}

		video {
			width: 100%;
			border: 2px solid #FFFFFF;
			cursor: pointer;
			background-color: #000000;
		}

		.video-selected {
			border: 4px solid yellow;
		}

		.video-fullscreen {
			width: 100vw;
			height: 100vh;
			position: fixed;
			top: 0;
			left: 0;
			z-index: 1000;
			background-color: black;
			object-fit: cover;
		}

		.video-info {
			position: fixed;
			top: 1em;
			left: 50%;
			transform: translateX(-50%);
			color: #FFFFFF;
			font-size: 2vw;
			background-color: rgba(0, 0, 0, 0.5);
			padding: 0.5em 1em;
			border-radius: 0.5em;
			z-index: 1001;
			display: none;
		}

		.log-box {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			max-height: 10%;
			background-color: rgba(0, 0, 0, 0.7);
			color: #FFFFFF;
			overflow-y: hidden;
			padding: 0.5em;
			font-size: 0.8em;
			z-index: 1002;
			display: none;
		}

		.log-box p {
			margin: 0.5em 0;
			word-wrap: break-word;
		}
	</style>
</head>

<script src="webOSTVjs-1.2.10/webOSTV.js" charset="utf-8"></script>
<script src="webOSTVjs-1.2.10/webOSTV-dev.js" charset="utf-8"></script>
<script type="text/javascript">
	//sample code for calling LS2 API
	webOS.service.request("luna://com.palm.systemservice", {
		method: "clock/getTime",
		parameters: {},
		onSuccess: function (args) {
			console.log("UTC:", args.utc);
			logMessage("Clock API success: UTC time fetched.");
		},
		onFailure: function (args) {
			console.log("Failed to getTime");
			logMessage("Clock API error: Failed to fetch UTC time.", true);
		}
	});

	function updateTime() {
		const now = new Date();
		const timeString = now.toLocaleTimeString();
		document.getElementById('time').textContent = timeString;
	}

	setInterval(updateTime, 1000);

	let selectedVideo = 0;
	let videos = []; // Initialize videos array

	window.onload = function () {
			// Video feed configuration moved here
			const config = {
				cameras: [
					{
						id: "camera1",
						url: "xxx",
						info: "Front Yard Camera"
					},
					{
						id: "camera2",
						url: "xxx",
						info: "Back Yard Camera"
					}
				]
			};

			// Start video feeds using the embedded configuration
			startVideoFeeds(config);
	};

	function startVideoFeeds(config) {
		const videoContainer = document.querySelector('.video-container');
		videoContainer.innerHTML = ''; // Clear existing videos
		videos = []; // Reset the videos array

		config.cameras.forEach((camera, index) => {
			const videoWrapper = document.createElement('div');
			videoWrapper.classList.add('video-wrapper');
			videoWrapper.style.position = 'relative';

			// Use the video feed URL in the grid view with autoplay disabled
			const video = document.createElement('video');
			video.src = camera.url; // Use the HLS stream URL directly
			video.autoplay = false; // Disable autoplay in grid view
			video.muted = true; // Mute video in grid view
			video.controls = false; // Hide controls in grid view
			video.classList.add('grid-video'); // Add a class for styling if needed
			video.style.width = '100%';
			video.style.height = '100%';
			video.style.cursor = 'pointer';
			videoWrapper.appendChild(video);

			videoContainer.appendChild(videoWrapper);
			videos.push(video); // Add video to the videos array

			 // Pointer mode: Add click event to open the video in full screen
			video.addEventListener('click', () => {
				openFullScreen(camera, index);
			});

			// Pointer mode: Highlight video on hover
			video.addEventListener('mouseover', () => {
				selectVideo(index);
			});
		});

		// Highlight the first video feed by default
		selectVideo(0);
	}

	function selectVideo(index) {
		videos.forEach((video, i) => {
			if (i === index) {
				video.classList.add('video-selected'); // Add yellow border to the selected video
			} else {
				video.classList.remove('video-selected'); // Remove yellow border from other videos
			}
		});
		selectedVideo = index; // Update the selected video index
	}

	function openFullScreen(camera, index) {
		const videoContainer = document.querySelector('.video-container');
		videoContainer.innerHTML = ''; // Clear the grid view

		const videoWrapper = document.createElement('div');
		videoWrapper.classList.add('video-wrapper');
		videoWrapper.style.position = 'relative';

		const video = document.createElement('video');
		video.id = `video${index + 1}`;
		video.src = camera.url; // Use the HLS stream URL directly
		video.autoplay = true; // Enable autoplay in full screen
		video.muted = false; // Enable audio for full screen playback
		video.controls = false; // Hide controls in full screen
		video.classList.add('video-fullscreen'); // Force full screen
		video.setAttribute('playsinline', 'true'); // Ensure inline playback on mobile devices
		video.setAttribute('type', 'application/vnd.apple.mpegurl'); // Specify HLS MIME type
		videoWrapper.appendChild(video);

		videoContainer.appendChild(videoWrapper);

		video.addEventListener('error', () => {
			logMessage(`Camera ${index + 1}: Error loading video stream.`, true);
		});

		 // Pointer mode: Add click event to return to grid view
		video.addEventListener('click', () => {
			startVideoFeeds(config);
		});

		// Override key bindings for full-screen mode (5-way mode)
		document.addEventListener('keydown', function handleFullScreenKeys(event) {
			switch (event.keyCode) {
				case 38: // UP key
					// Go to the previous camera
					const prevIndex = (index - 1 + config.cameras.length) % config.cameras.length;
					openFullScreen(config.cameras[prevIndex], prevIndex);
					break;
				case 40: // DOWN key
					// Go to the next camera
					const nextIndex = (index + 1) % config.cameras.length;
					openFullScreen(config.cameras[nextIndex], nextIndex);
					break;
				case 13: // ENTER key
				case 461: // BACK key
					// Return to the grid view
					document.removeEventListener('keydown', handleFullScreenKeys); // Remove the event listener
					startVideoFeeds(config);
					break;
			}
		});
	}

	document.addEventListener('keydown', function(event) {
		// 5-way mode: Handle navigation in grid view
		switch (event.keyCode) {
			case 38: // UP key
				selectVideo((selectedVideo - 1 + videos.length) % videos.length);
				break;
			case 40: // DOWN key
				selectVideo((selectedVideo + 1) % videos.length);
				break;
			case 37: // LEFT key
				selectVideo((selectedVideo - 1 + videos.length) % videos.length);
				break;
			case 39: // RIGHT key
				selectVideo((selectedVideo + 1) % videos.length);
				break;
			case 13: // ENTER key
				openFullScreen(config.cameras[selectedVideo], selectedVideo);
				break;
			default:
				break; // Add a default case to handle unexpected keys
		}
	});

	// Function to log messages to the log box
	function logMessage(message, isError = false) {
		// Ensure log box exists before appending
		const logBox = document.getElementById('log-box');
		if (!logBox) {
			console.error("Log box element not found.");
			return;
		}
		const logEntry = document.createElement('p');
		logEntry.textContent = message;
		logEntry.style.color = isError ? 'red' : '#FFFFFF'; // Highlight errors in red
		logBox.appendChild(logEntry);
		logBox.scrollTop = logBox.scrollHeight; // Auto-scroll to the latest log

		// Show the log box only if there are error messages
		if (isError) {
			logBox.style.display = 'block';
			setTimeout(() => {
				logBox.style.display = 'none'; // Hide the log box after 5 seconds
			}, 5000);
		}
	}
</script>

<body>
	<div>
		<h1>Hello, Webcam!</h1>
		<p id="time"></p>
		<div class="video-container"></div>
		<div id="video-info" class="video-info"></div>
		<div id="log-box" class="log-box"></div> <!-- Log box added -->
	</div>
</body>

</html>
