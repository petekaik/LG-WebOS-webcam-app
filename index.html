<!DOCTYPE html>
<html>

<head>
	<title>Webcam Viewer</title>
	<style type="text/css">
		body {
			width: 100%;
			height: 100%;
			background-color: #202020;
			margin: 0;
			padding: 0;
			overflow: hidden;
			font-family: Arial, sans-serif;
			color: #FFFFFF;
		}

		.container {
			position: absolute; /* Changed from relative to absolute for better control */
			width: 100%;
			height: 100%;
			display: -webkit-box; /* Fallback for older browsers */
			display: -ms-flexbox; /* Fallback for IE */
			display: flex;
			-webkit-box-orient: vertical;
			-webkit-box-direction: normal;
			-ms-flex-direction: column;
			flex-direction: column;
			overflow: hidden; /* Prevent the main container from scrolling */
		}

		.header {
			height: 60px;
			background-color: #101010;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0 20px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
			z-index: 10;
			flex-shrink: 0; /* Prevent header from shrinking */
		}

		.header-left {
			display: flex;
			align-items: center;
			margin-right: 15px; /* Replace gap */
		}

		.app-title {
			font-size: 24px;
			font-weight: bold;
		}

		.header-right {
			display: flex;
			align-items: center;
		}

		.clock {
			position: absolute;
			top: 15px;
			left: 50%;
			transform: translateX(-50%);
			background-color: rgba(0, 0, 0, 0.7);
			padding: 5px 15px;
			border-radius: 5px;
			font-size: 20px;
			z-index: 11;
			color: #FFFFFF;
			display: block;
		}

		/* Hide header and clock when in fullscreen mode */
		.container.fullscreen-active .clock,
		.container.fullscreen-active .header {
			display: none;
		}

		.settings-button {
			background-color: transparent;
			border: none;
			color: #FFFFFF;
			cursor: pointer;
			font-size: 18px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 8px;
			border-radius: 4px;
			transition: background-color 0.2s;
			margin-left: 20px;
		}

		.settings-button.focused {
			background-color: rgba(66, 133, 244, 0.6);
		}

		.settings-button:hover {
			background-color: rgba(255, 255, 255, 0.1);
		 }

		/* Grid layout to display webcams */
		.webcam-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr); /* Display 2 columns by default */
			grid-template-rows: repeat(2, 1fr); /* Display 2 rows by default */
			grid-gap: 15px;
			padding: 15px;
			box-sizing: border-box;
			width: 100%;
			height: calc(100vh - 60px); /* Subtract header height */
			overflow: hidden;
		}

		/* Webcam container styles */
		.webcam-container {
			width: 100%;
			height: 100%; 
			max-height: 45vh; /* Limit maximum height to prevent overflow */
			display: flex;
			justify-content: center;
			align-items: center;
			position: relative;
			background-color: #111;
			border: 1px solid #333;
			overflow: hidden;
			-webkit-transition: -webkit-transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
			transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
			min-width: 0;
			min-height: 0;
		}

		.webcam-container.focused {
			border-color: #4285f4; /* Use border-color instead of border */
			box-shadow: 0 0 15px rgba(66, 133, 244, 0.8);
			transform: scale(1.02);
			z-index: 2;
		}

		.webcam-feed {
			/* Ensure video scales within the container */
			max-width: 100%; 
			max-height: 100%;
			width: auto; /* Maintain aspect ratio */
			height: auto; /* Maintain aspect ratio */
			object-fit: contain; /* Scale video while preserving aspect ratio */
			-webkit-object-fit: contain; /* Fallback for older browsers */
			display: block; /* Remove extra space below video */
			background-color: #000;
			min-width: 0; /* Ensure video can shrink */
			min-height: 0; /* Ensure video can shrink */
		}

		.webcam-label {
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			background-color: rgba(0, 0, 0, 0.7);
			padding: 8px;
			text-align: center;
			transition: opacity 0.5s ease; /* Add transition for smooth hiding */
		}

		.fullscreen-mode {
			position: absolute;
			top: 0; /* Changed from 60px to 0 to use full screen height */
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #000000;
			z-index: 100;
			display: none;
		}

		.log-box {
			position: absolute;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background-color: rgba(0, 0, 0, 0.8);
			border-radius: 8px;
			padding: 10px 20px;
			min-width: 300px;
			max-width: 80%;
			text-align: center;
			opacity: 0;
			transition: opacity 0.3s;
			z-index: 20;
		}

		.log-box.show {
			opacity: 1;
		}

		.navigation-hint {
			position: absolute;
			bottom: 10px;
			right: 10px;
			background-color: rgba(0, 0, 0, 0.6);
			padding: 10px;
			border-radius: 5px;
			font-size: 14px;
			color: #FFFFFF;
		}
		
		.stream-placeholder {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			text-align: center;
			background-color: #303030;
			color: #aaaaaa;
			padding: 20px;
		}
		
		.stream-placeholder-icon {
			font-size: 32px;
			margin-bottom: 10px;
		}
		
		.stream-placeholder-text {
			font-size: 14px;
			max-width: 80%;
		}

		/* Settings modal styling */
		.settings-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.7);
			z-index: 100;
			display: none;
			justify-content: center;
			align-items: center;
		}

		.settings-modal {
			width: 80%;
			max-width: 800px;
			max-height: 80vh;
			background-color: #303030;
			border-radius: 8px;
			box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.settings-header {
			background-color: #202020;
			padding: 15px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 1px solid #404040;
		}

		.settings-title {
			font-size: 22px;
			font-weight: bold;
		}

		.settings-close {
			background: transparent;
			border: none;
			color: #FFFFFF;
			font-size: 22px;
			cursor: pointer;
		}

		.settings-content {
			flex: 1;
			padding: 20px;
			overflow-y: auto;
		}

		.settings-section {
			margin-bottom: 25px;
		}

		.settings-section-title {
			font-size: 18px;
			font-weight: bold;
			margin-bottom: 15px;
			border-bottom: 1px solid #404040;
			padding-bottom: 5px;
		}

		.webcam-list {
			display: flex;
			flex-direction: column;
			margin-bottom: 15px; /* Replace gap */
		}

		.webcam-item {
			background-color: #252525;
			border-radius: 6px;
			padding: 18px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: background-color 0.2s;
			margin-bottom: 12px;
		}

		.webcam-item.focused {
			background-color: #3a3a3a;
			box-shadow: 0 0 0 2px #4285f4;
		}

		.webcam-item-info {
			flex: 1;
			padding-right: 15px;
		}

		.webcam-item-name {
			font-weight: bold;
			margin-bottom: 8px;
			font-size: 16px;
		}

		.webcam-item-url {
			font-size: 12px;
			color: #aaaaaa;
			word-break: break-all;
		}

		.webcam-item-actions {
			display: flex;
			margin-left: 15px; /* Replace gap */
			align-items: center;
		}
		
		.webcam-enabled-status {
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 14px;
			background-color: rgba(0, 0, 0, 0.2);
			min-width: 70px;
			text-align: center;
			margin-right: 5px;
		}

		.action-button {
			background-color: transparent;
			border: 1px solid #505050;
			color: #FFFFFF;
			padding: 8px 14px; /* Slightly increased padding */
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.2s;
			margin: 0 5px; /* Add horizontal margin */
		}

		.action-button:hover, .action-button.focused {
			background-color: rgba(66, 133, 244, 0.2);
			border-color: #4285f4;
		}

		.action-button.delete {
			border-color: #ff4d4d;
			color: #ff4d4d;
		}

		.action-button.delete:hover, .action-button.delete.focused {
			background-color: rgba(255, 77, 77, 0.2);
		}

		.add-webcam-form {
			background-color: #252525;
			border-radius: 6px;
			padding: 15px;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 8px;
			font-size: 15px;
		}

		.form-control {
			width: 100%;
			padding: 12px;
			background-color: #404040;
			border: 1px solid #505050;
			color: #FFFFFF;
			border-radius: 4px;
			font-size: 15px;
			box-sizing: border-box;
		}

		.form-buttons {
			display: flex;
			justify-content: flex-end;
			margin-left: 20px; /* Replace gap */
			margin-top: 25px;
			flex-wrap: wrap; /* Allow wrapping on smaller screens */
		}

		.settings-buttons {
			display: flex;
			justify-content: flex-end;
			margin-left: 20px; /* Replace gap */
			margin-top: 25px;
			flex-wrap: wrap; /* Allow wrapping on smaller screens */
		}

		.btn {
			padding: 12px 18px;
			background-color: #1d86e2;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 16px;
			min-width: 110px;
			margin: 5px; /* Add margin to all sides */
			transition: background-color 0.2s;
		}
		
		.btn:hover, .btn:focus {
			background-color: #166bb8;
		}

		.settings-footer {
			background-color: #252525;
			padding: 15px 20px;
			display: flex;
			justify-content: flex-end;
			margin-left: 15px; /* Replace gap */
			border-top: 1px solid #404040;
		}
		
		/* Splash screen styling */
		.splash-screen {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: #101010;
			z-index: 1000;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			transition: opacity 0.5s ease-in-out;
		}
		
		.splash-logo {
			font-size: 42px;
			font-weight: bold;
			color: #FFFFFF;
			margin-bottom: 20px;
			text-align: center;
		}
		
		.splash-spinner {
			width: 60px;
			height: 60px;
			border: 5px solid rgba(255, 255, 255, 0.3);
			border-radius: 50%;
			border-top-color: #FFFFFF;
			animation: spin 1s ease-in-out infinite;
		}
		
		@keyframes spin {
			to { transform: rotate(360deg); }
		}
		
		.splash-message {
			margin-top: 20px;
			font-size: 18px;
			color: #CCCCCC;
		}
		
		.hidden {
			opacity: 0;
			pointer-events: none;
		}

		/* General Styles */
		body {
			margin: 0;
			padding: 0;
			background-color: #000;
			color: #fff;
			font-family: Arial, sans-serif;
			overflow: hidden;
		}

		/* Grid Layout */
		.video-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			grid-row-gap: 10px; /* Replace grid-gap */
			grid-column-gap: 10px; /* Replace grid-gap */
			padding: 10px;
			height: calc(100vh - 60px);
		}

		/* Settings Panel */
		.settings-menu {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: rgba(0, 0, 0, 0.9);
			border: 1px solid #444;
			border-radius: 10px;
			padding: 20px;
			width: 60%;
			max-height: 80%;
			overflow-y: auto;
			z-index: 1000;
		}

		.hidden {
			display: none;
		}

		.settings-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			border-bottom: 1px solid #444;
			padding-bottom: 10px;
		}

		.settings-section {
			margin-bottom: 20px;
		}

		.webcam-list {
			margin-bottom: 15px;
		}

		.webcam-item {
			padding: 10px;
			background-color: #333;
			margin-bottom: 5px;
			border-radius: 5px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.webcam-item-selected {
			background-color: #1d86e2;
		}

		.webcam-item-name {
			font-weight: bold;
		}

		/* Video Container */
		.video-container {
			position: relative;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}

		.video-container video {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.video-container.selected {
			border: 3px solid #1d86e2;
		}

		.video-overlay {
			position: absolute;
			bottom: 10px;
			left: 10px;
			background-color: rgba(0, 0, 0, 0.7);
			padding: 5px 10px;
			border-radius: 5px;
		}

		/* Clock */
		.clock {
			position: absolute;
			top: 15px;
			left: 50%;
			transform: translateX(-50%);
			background-color: rgba(0, 0, 0, 0.7);
			padding: 5px 15px;
			border-radius: 5px;
			font-size: 20px;
			z-index: 11;
			color: #FFFFFF;
			display: block;
		}

		.container.fullscreen-active .clock {
			display: none;
		}

		/* Log Box */
		.log-container {
			position: absolute;
			bottom: 10px;
			right: 10px;
			background-color: rgba(0, 0, 0, 0.7);
			padding: 10px;
			border-radius: 5px;
			max-width: 300px;
			max-height: 200px;
			overflow-y: auto;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.log-container.visible {
			opacity: 1;
		}

		.log-entry {
			margin-bottom: 5px;
			font-size: 14px;
		}

		.log-entry.error {
			color: #ff5252;
		}

		.log-entry.info {
			color: #4caf50;
		}

		/* Network Status Indicator */
		.network-status {
			position: absolute;
			top: 10px;
			left: 10px;
			display: flex;
			align-items: center;
			background-color: rgba(0, 0, 0, 0.7);
			padding: 5px 10px;
			border-radius: 5px;
		}

		.network-indicator {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			margin-right: 8px;
		}

		.network-online {
			background-color: #4caf50;
		}

		.network-offline {
			background-color: #ff5252;
		}

		/* Fullscreen mode */
		.fullscreen-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			z-index: 900;
			background-color: #000;
		}

		.fullscreen-container video {
			width: 100%;
			height: 100%;
			object-fit: contain;
		}

		.fullscreen-overlay {
			position: absolute;
			bottom: 20px;
			left: 20px;
			background-color: rgba(0, 0, 0, 0.7);
			padding: 10px;
			border-radius: 5px;
			font-size: 24px;
		}

		/* Media queries for responsive design */
		@media (max-width: 768px) {
			.video-grid {
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			}
		}

        /* Grid Layout Settings */
        #custom-grid-options {
            margin-top: 15px;
        }
        
        #custom-grid-options input {
            width: 50px;
            margin-right: 20px;
        }
        
        /* Network Status Indicator */
        #network-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            color: white;
            display: flex;
            align-items: center;
            margin-left: 5px; /* Replace gap */
        }
        
        .status-online {
            background-color: #2ecc71;
        }
        
        .status-offline {
            background-color: #e74c3c;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
		/* Base styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'LG Smart', 'Roboto', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        /* Network status indicator styles */
        #network-status {
            display: flex;
            align-items: center;
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .status-online {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .status-offline {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        /* Grid settings specific styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        #custom-grid-options {
            margin-top: 5px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        /* Confirmation dialog styles */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .confirmation-dialog-content {
            background-color: #303030;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .confirmation-dialog-header {
            background-color: #252525;
            padding: 15px 20px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .confirmation-dialog-body {
            padding: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        .confirmation-dialog-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            margin-left: 15px; /* Replace gap */
            background-color: #252525;
        }
        
        .hidden {
            display: none;
        }
	</style>
</head>

<script src="webOSTVjs-1.2.10/webOSTV.js" charset="utf-8"></script>
<script type="text/javascript">
	// Default webcam configuration
    var defaultWebcamConfig = [
        { id: 1, name: 'Front Door', url: 'http://192.168.1.20:8888/etupiha/index.m3u8', enabled: true },
        { id: 2, name: 'Back Yard', url: 'http://192.168.1.20:8888/takapiha/index.m3u8', enabled: true },
        { id: 3, name: 'Living Room', url: 'http://192.168.1.102:8080/video', enabled: false },
        { id: 4, name: 'Garage', url: 'http://192.168.1.103:8080/video', enabled: false }
    ];

    // Default layout settings
    var defaultLayoutSettings = {
        gridRows: 2,
        gridColumns: 2,
        autoLayout: true,
        showLabels: true,
        refreshInterval: 0, // 0 means no refresh, value in seconds
        debugMode: false // Debug mode disabled by default
    };

    // Global variables
    var webcamConfig = [];
    var layoutSettings = {};
    var selectedWebcam = null;
    var isFullscreen = false;
	var currentFocusedCam = null;
	var isFullscreenMode = false;
	var activeFullscreenCam = null;
	var isSettingsOpen = false;
	var clockInterval;
	var appLoaded = false;
	var loadedStreams = 0;
	var attemptedStreams = 0; // Added counter for attempted loads
	var networkStatus = "online";
	var currentGridColumns = 2; // Store the current number of grid columns
	var fullscreenLabelTimer = null; // Timer for hiding fullscreen label after delay
	
	// Log a message to console and UI if needed
	function logMessage(message, isDebug) {
		if (isDebug && (!layoutSettings || !layoutSettings.debugMode)) {
			// Skip debug messages if not in debug mode
			return;
		}
		
		console.log(message);
		
		try {
			var logBox = document.getElementById('log-box');
			if (logBox) {
				logBox.textContent = message;
				logBox.classList.add('show');
				
				// Hide after short delay
				setTimeout(function() {
					logBox.classList.remove('show');
				}, 3000);
			}
		} catch (e) {
			console.error("Error showing log message:", e);
		}
	}

	// Function containing WebOS-dependent initialization
	function initializeApp() {
		try {
			logMessage("webOS is ready. Initializing App Components...");
			console.log("[Debug] initializeApp called."); // Debug log

			// Initialize components that depend on webOS or DOM elements
			initializeClock();
			console.log("[Debug] Clock initialized."); // Debug log
			initNetworkMonitoring();  // Initialize network monitoring
			console.log("[Debug] Network monitoring initialized."); // Debug log
			loadWebcams(); // Starts loading streams asynchronously
			console.log("[Debug] loadWebcams called."); // Debug log
			setupNavigation();
			console.log("[Debug] Navigation setup."); // Debug log

			// Initial check after 2 seconds minimum display time (relative to app init)
			console.log("[Debug] Setting 2s checkAllResourcesLoaded timer..."); // Debug log
			setTimeout(function() {
				console.log("[Debug] 2s timer fired - calling checkAllResourcesLoaded"); // Debug log
				checkAllResourcesLoaded();
			}, 2000);

		} catch (error) {
			logMessage("Error during app initialization: " + error.message);
			console.error("Error in initializeApp:", error);
			// Attempt to hide splash screen immediately if an error occurs here
			console.log("[Debug] Error in initializeApp - attempting immediate hideSplashScreen"); // Debug log
			hideSplashScreen();
		}
	}
	
	// Initialize network monitoring
	function initNetworkMonitoring() {
		// Check initial network status
		updateNetworkStatus();
		
		// Set up periodic checks
		setInterval(updateNetworkStatus, 10000); // Check every 10 seconds
	}
	
	// Update network status indicator
	function updateNetworkStatus() {
		try {
			// Simple network check - will throw error if offline
			var isOnline = navigator.onLine;
			networkStatus = isOnline ? "online" : "offline";
			
			// Update UI if exists
			var statusElement = document.getElementById('network-status');
			if (statusElement) {
				statusElement.className = isOnline ? 'status-online' : 'status-offline';
				statusElement.textContent = isOnline ? 'Network Connected' : 'Network Disconnected';
			}
		} catch (error) {
			console.error("Error checking network:", error);
		}
	}
	
	// Setup keyboard navigation
	function setupNavigation() {
		document.addEventListener('keydown', function(event) {
			if (isFullscreenMode) {
				handleFullscreenNavigation(event);
			} else if (isSettingsOpen) {
				handleSettingsNavigation(event);
			} else {
				handleGridNavigation(event);
			}
		});
	}
	
	// Handle navigation in grid view
	function handleGridNavigation(event) {
		// Get all webcam containers
		var containers = document.querySelectorAll('.webcam-container');
		if (containers.length === 0) return;
		
		// Find current focused container index
		var currentIndex = -1;
		for (var i = 0; i < containers.length; i++) {
			if (containers[i].classList.contains('focused')) {
				currentIndex = i;
				break;
			}
		}
		
		// If none focused, focus the first one
		if (currentIndex === -1) {
			containers[0].classList.add('focused');
			currentFocusedCam = parseInt(containers[0].getAttribute('data-cam-id'));
			return;
		}
		
		var targetIndex = currentIndex;
		// Use the current grid columns from our layout settings
		var cols = currentGridColumns;
		
		switch (event.keyCode) {
			case 37: // LEFT
				if (currentIndex % cols > 0) {
					targetIndex = currentIndex - 1;
				}
				break;
			case 39: // RIGHT
				if (currentIndex % cols < cols - 1 && currentIndex < containers.length - 1) {
					targetIndex = currentIndex + 1;
				}
				break;
			case 38: // UP
				if (currentIndex - cols >= 0) {
					targetIndex = currentIndex - cols;
				}
				break;
			case 40: // DOWN
				if (currentIndex + cols < containers.length) {
					targetIndex = currentIndex + cols;
				}
				break;
			case 13: // ENTER
				if (currentFocusedCam !== null) {
					enterFullscreen(currentFocusedCam);
				}
				break;
			case 461: // BACK button on WebOS remote
			case 27:  // ESC key (for testing in browser)
				event.preventDefault();
				// No action in grid mode for back button
				break;
		}
		
		if (targetIndex !== currentIndex && targetIndex >= 0 && targetIndex < containers.length) {
			containers[currentIndex].classList.remove('focused');
			containers[targetIndex].classList.add('focused');
			currentFocusedCam = parseInt(containers[targetIndex].getAttribute('data-cam-id'));
			
			// Log navigation for debugging
			logMessage("Grid navigation: " + currentIndex + " -> " + targetIndex, true);
		}
	}
	
	// Add missing functions that were referenced
	function loadWebcams() {
		console.log("[Debug] loadWebcams: Starting..."); // Debug log
		var webcamGrid = document.getElementById('webcam-grid');
		if (!webcamGrid) {
			console.error("Webcam grid element not found");
			return;
		}
		
		webcamGrid.innerHTML = ''; // Clear existing content
		
		// Filter for enabled webcams only
		var enabledWebcams = webcamConfig.filter(function(cam) { 
			return cam.enabled; 
		});
		
		if (enabledWebcams.length === 0) {
			webcamGrid.innerHTML = '<div class="no-webcams">No webcams enabled. Add webcams in settings.</div>';
			return;
		}
		
		 // Update grid layout based on number of cameras
		var numCams = enabledWebcams.length;
		var columns, rows;
		
		if (layoutSettings.autoLayout) {
			// Calculate optimal grid dimensions based on number of cameras
			if (numCams <= 1) {
				columns = 1;
				rows = 1;
			} else if (numCams <= 2) {
				columns = 2;
				rows = 1;
			} else if (numCams <= 4) {
				columns = 2;
				rows = 2;
			} else if (numCams <= 6) {
				columns = 3;
				rows = 2;
			} else if (numCams <= 9) {
				columns = 3;
				rows = 3;
			} else {
				columns = 4;
				rows = Math.ceil(numCams / 4);
			}
		} else {
			// Use custom grid dimensions from settings
			columns = layoutSettings.gridColumns || 2;
			rows = layoutSettings.gridRows || 2;
		}
		
		// Store the current number of grid columns for navigation
		currentGridColumns = columns;
		
		// Apply the grid layout to the container
		webcamGrid.style.gridTemplateColumns = 'repeat(' + columns + ', 1fr)';
		webcamGrid.style.gridTemplateRows = 'repeat(' + rows + ', 1fr)';
		
		// Create webcam containers with video elements
		enabledWebcams.forEach(function(cam) {
			var container = document.createElement('div');
			container.className = 'webcam-container';
			container.setAttribute('data-cam-id', cam.id);
			
			// Create video element for the stream
			var video = document.createElement('video');
			video.className = 'webcam-feed';
			video.setAttribute('playsinline', '');
			video.setAttribute('autoplay', '');
			video.setAttribute('muted', '');
			video.setAttribute('src', cam.url);
			
			// Add error handling for video stream
			video.onerror = function() {
				console.log("[Debug] Error loading stream for camera: " + cam.name);
				// Create placeholder for failed stream
				var placeholder = document.createElement('div');
				placeholder.className = 'stream-placeholder';
				placeholder.innerHTML = '<div class="stream-placeholder-icon">⚠️</div>' +
					'<div class="stream-placeholder-text">Stream unavailable</div>';
				container.appendChild(placeholder);
				attemptedStreams++;
				checkAllResourcesLoaded();
			};
			
			// Add load handling
			video.onloadeddata = function() {
				console.log("[Debug] Stream loaded for camera: " + cam.name);
				loadedStreams++;
				attemptedStreams++;
				checkAllResourcesLoaded();
			};
			
			container.appendChild(video);
			
			// Add label if enabled
			if (layoutSettings.showLabels !== false) {
				var label = document.createElement('div');
				label.className = 'webcam-label';
				label.textContent = cam.name;
				container.appendChild(label);
			}
			
			webcamGrid.appendChild(container);
		});
		
		// Set first container as focused
		var firstContainer = document.querySelector('.webcam-container');
		if (firstContainer) {
			firstContainer.classList.add('focused');
			currentFocusedCam = parseInt(firstContainer.getAttribute('data-cam-id'));
		}
	}

	// Enter fullscreen mode for a webcam
	function enterFullscreen(camId) {
		isFullscreenMode = true;
		activeFullscreenCam = camId;
		
		var fullscreenMode = document.getElementById('fullscreen-mode');
		var fullscreenVideo = document.getElementById('fullscreen-video');
		var fullscreenLabel = document.getElementById('fullscreen-label');
		
		if (fullscreenMode && fullscreenVideo && fullscreenLabel) {
			// Display the fullscreen container
			fullscreenMode.style.display = 'block';
			
			// Find the webcam info
			var cam = webcamConfig.find(function(c) { 
				return c.id === camId; 
			});
			
			if (cam) {
				// Set the video source to the selected camera
				fullscreenVideo.setAttribute('src', cam.url);
				fullscreenVideo.play();
				
				// Update the label with camera name
				fullscreenLabel.textContent = cam.name;
				
				logMessage("Entering fullscreen mode: " + cam.name, true);
			}
		}
	}
	
	// Handle navigation in fullscreen mode
	function handleFullscreenNavigation(event) {
		// Get all enabled webcams
		var enabledWebcams = webcamConfig.filter(function(cam) { 
			return cam.enabled; 
		});
		
		if (enabledWebcams.length <= 1) {
			// Only one camera, only handle exit
			if (event.keyCode === 461 || event.keyCode === 27 || event.keyCode === 37) { // BACK, ESC or LEFT
				exitFullscreen();
			}
			return;
		}
		
		// Find current camera's index in the enabled webcams array
		var currentIndex = -1;
		for (var i = 0; i < enabledWebcams.length; i++) {
			if (enabledWebcams[i].id === activeFullscreenCam) {
				currentIndex = i;
				break;
			}
		}
		
		if (currentIndex === -1) return; // Camera not found
		
		var nextIndex = currentIndex;
		
		switch (event.keyCode) {
			case 38: // UP key
				// Move to previous camera
				nextIndex = (currentIndex - 1 + enabledWebcams.length) % enabledWebcams.length;
				enterFullscreen(enabledWebcams[nextIndex].id);
				break;
				
			case 40: // DOWN key
				// Move to next camera
				nextIndex = (currentIndex + 1) % enabledWebcams.length;
				enterFullscreen(enabledWebcams[nextIndex].id);
				break;
				
			case 461: // BACK button on WebOS remote
			case 27:  // ESC key (for testing in browser)
			case 37:  // LEFT key
				exitFullscreen();
				event.preventDefault();
				break;
		}
		
		if (nextIndex !== currentIndex) {
			logMessage("Fullscreen navigation: " + enabledWebcams[currentIndex].name + " -> " + 
				enabledWebcams[nextIndex].name, true);
		}
	}
	
	// Exit fullscreen mode
	function exitFullscreen() {
		var fullscreenMode = document.getElementById('fullscreen-mode');
		if (fullscreenMode) {
			fullscreenMode.style.display = 'none';
		}
		
		isFullscreenMode = false;
		activeFullscreenCam = null;
	}
	
	// Handle navigation in settings
	function handleSettingsNavigation(event) {
		// Placeholder for settings navigation
	}

	// Open settings menu
	function openSettingsMenu() {
		isSettingsOpen = true;
		var settingsOverlay = document.getElementById('settings-overlay');
		if (settingsOverlay) {
			settingsOverlay.style.display = 'flex';
			refreshSettingsList(); // Refresh the settings content
			logMessage("Settings opened");
		}
	}
	
	// Close settings menu
	function closeSettingsMenu() {
		isSettingsOpen = false;
		var settingsOverlay = document.getElementById('settings-overlay');
		if (settingsOverlay) {
			settingsOverlay.style.display = 'none';
		}
		logMessage("Settings closed");
	}

	// Refresh the settings list in the settings menu
	function refreshSettingsList() {
		var webcamList = document.getElementById('settings-webcam-list');
		if (!webcamList) return;
		
		webcamList.innerHTML = '';
		
		if (webcamConfig.length === 0) {
			webcamList.innerHTML = '<div class="no-webcams">No webcams configured</div>';
			return;
		}
		
		webcamConfig.forEach(function(cam) {
			var item = document.createElement('div');
			item.className = 'webcam-item';
			item.setAttribute('data-cam-id', cam.id);
			
			var info = document.createElement('div');
			info.className = 'webcam-item-info';
			
			var name = document.createElement('div');
			name.className = 'webcam-item-name';
			name.textContent = cam.name;
			
			var url = document.createElement('div');
			url.className = 'webcam-item-url';
			url.textContent = cam.url;
			
			info.appendChild(name);
			info.appendChild(url);
			
			var actions = document.createElement('div');
			actions.className = 'webcam-item-actions';
			
			// Status indicator (enabled/disabled)
			var status = document.createElement('div');
			status.className = 'webcam-enabled-status';
			status.textContent = cam.enabled ? 'Enabled' : 'Disabled';
			status.style.backgroundColor = cam.enabled ? 'rgba(46, 204, 113, 0.2)' : 'rgba(231, 76, 60, 0.2)';
			status.style.color = cam.enabled ? '#2ecc71' : '#e74c3c';
			
			var editBtn = document.createElement('button');
			editBtn.className = 'action-button';
			editBtn.textContent = 'Edit';
			editBtn.addEventListener('click', function() {
				editWebcam(cam.id);
			});
			
			var deleteBtn = document.createElement('button');
			deleteBtn.className = 'action-button delete';
			deleteBtn.textContent = 'Delete';
			deleteBtn.addEventListener('click', function() {
				showDeleteConfirmation(cam.id);
			});
			
			actions.appendChild(status);
			actions.appendChild(editBtn);
			actions.appendChild(deleteBtn);
			
			item.appendChild(info);
			item.appendChild(actions);
			webcamList.appendChild(item);
		});
	}
	
	// Show settings section and hide others
	function showSettingsSection(sectionId) {
		var sections = [
			'settings-list-mode',
			'settings-add-mode',
			'settings-edit-mode',
			'settings-grid-layout-mode'
		];
		
		sections.forEach(function(section) {
			var element = document.getElementById(section);
			if (element) {
				if (section === sectionId) {
					element.classList.remove('hidden');
				} else {
					element.classList.add('hidden');
				}
			}
		});
		
		logMessage("Showing settings section: " + sectionId);
	}
	
	// Add webcam - show the add webcam form
	function showAddWebcamForm() {
		// Clear form fields
		document.getElementById('new-webcam-name').value = '';
		document.getElementById('new-webcam-url').value = '';
		document.getElementById('new-webcam-enabled').checked = true;
		
		showSettingsSection('settings-add-mode');
	}
	
	// Save new webcam from form
	function saveNewWebcam() {
		var name = document.getElementById('new-webcam-name').value.trim();
		var url = document.getElementById('new-webcam-url').value.trim();
		var enabled = document.getElementById('new-webcam-enabled').checked;
		
		if (!name || !url) {
			logMessage("Please fill in all required fields");
			return;
		}
		
		// Generate a new unique ID
		var maxId = 0;
		webcamConfig.forEach(function(cam) {
			if (cam.id > maxId) maxId = cam.id;
		});
		
		var newCam = {
			id: maxId + 1,
			name: name,
			url: url,
			enabled: enabled
		};
		
		webcamConfig.push(newCam);
		saveSettings();
		
		// Return to main settings list
		showSettingsSection('settings-list-mode');
		refreshSettingsList();
		
		// Reload webcams if this is enabled
		if (enabled) {
			loadWebcams();
		}
		
		logMessage("New webcam added: " + name);
	}
	
	// Edit webcam - show the edit webcam form
	function editWebcam(webcamId) {
		var cam = webcamConfig.find(function(c) { return c.id === webcamId; });
		if (!cam) {
			logMessage("Webcam not found");
			return;
		}
		
		document.getElementById('edit-webcam-id').value = cam.id;
		document.getElementById('edit-webcam-name').value = cam.name;
		document.getElementById('edit-webcam-url').value = cam.url;
		document.getElementById('edit-webcam-enabled').checked = cam.enabled;
		
		showSettingsSection('settings-edit-mode');
		logMessage("Editing webcam: " + cam.name);
	}
	
	// Save edited webcam from form
	function saveEditedWebcam() {
		var id = parseInt(document.getElementById('edit-webcam-id').value);
		var name = document.getElementById('edit-webcam-name').value.trim();
		var url = document.getElementById('edit-webcam-url').value.trim();
		var enabled = document.getElementById('edit-webcam-enabled').checked;
		
		if (!name || !url) {
			logMessage("Please fill in all required fields");
			return;
		}
		
		var camIndex = webcamConfig.findIndex(function(c) { return c.id === id; });
		if (camIndex === -1) {
			logMessage("Webcam not found");
			return;
		}
		
		var wasEnabled = webcamConfig[camIndex].enabled;
		
		// Update webcam config
		webcamConfig[camIndex].name = name;
		webcamConfig[camIndex].url = url;
		webcamConfig[camIndex].enabled = enabled;
		
		saveSettings();
		
		// Return to main settings list
		showSettingsSection('settings-list-mode');
		refreshSettingsList();
		
		// Reload webcams if enabled status changed
		if (wasEnabled !== enabled || enabled) {
			loadWebcams();
		}
		
		logMessage("Webcam updated: " + name);
	}
	
	// Show delete confirmation
	function showDeleteConfirmation(webcamId) {
		var cam = webcamConfig.find(function(c) { return c.id === webcamId; });
		if (!cam) {
			logMessage("Webcam not found");
			return;
		}
		
		document.getElementById('delete-webcam-name').textContent = cam.name;
		document.getElementById('confirmation-dialog').classList.remove('hidden');
		
		// Set delete button action
		var confirmButton = document.getElementById('confirm-delete-btn');
		confirmButton.onclick = function() {
			deleteWebcam(webcamId);
		};
	}
	
	// Delete webcam
	function deleteWebcam(webcamId) {
		var camIndex = webcamConfig.findIndex(function(c) { return c.id === webcamId; });
		if (camIndex === -1) {
			logMessage("Webcam not found");
			return;
		}
		
		var wasEnabled = webcamConfig[camIndex].enabled;
		var name = webcamConfig[camIndex].name;
		
		// Remove webcam from config
		webcamConfig.splice(camIndex, 1);
		saveSettings();
		
		// Close confirmation dialog
		document.getElementById('confirmation-dialog').classList.add('hidden');
		
		// Refresh settings list
		refreshSettingsList();
		
		// Reload webcams if the deleted one was enabled
		if (wasEnabled) {
			loadWebcams();
		}
		
		logMessage("Webcam deleted: " + name);
	}
	
	// Show grid layout settings
	function showGridLayoutSettings() {
		// Populate form with current settings
		document.getElementById('grid-type').value = layoutSettings.autoLayout ? 'auto' : 'custom';
		document.getElementById('grid-rows').value = layoutSettings.gridRows;
		document.getElementById('grid-columns').value = layoutSettings.gridColumns;
		document.getElementById('show-labels').checked = layoutSettings.showLabels !== false;
		document.getElementById('auto-refresh').value = layoutSettings.refreshInterval || 0;
		document.getElementById('debug-mode').checked = layoutSettings.debugMode === true;
		
		// Update visibility of custom grid options
		updateCustomGridOptions();
		
		showSettingsSection('settings-grid-layout-mode');
	}
	
	// Update visibility of custom grid options based on selected grid type
	function updateCustomGridOptions() {
		var gridType = document.getElementById('grid-type').value;
		var customOptions = document.getElementById('custom-grid-options');
		
		if (gridType === 'custom') {
			customOptions.style.display = 'block';
		} else {
			customOptions.style.display = 'none';
		}
	}
	
	// Save grid layout settings
	function saveLayoutSettings() {
		var gridType = document.getElementById('grid-type').value;
		var gridRows = parseInt(document.getElementById('grid-rows').value) || 2;
		var gridColumns = parseInt(document.getElementById('grid-columns').value) || 2;
		var showLabels = document.getElementById('show-labels').checked;
		var refreshInterval = parseInt(document.getElementById('auto-refresh').value) || 0;
		var debugMode = document.getElementById('debug-mode').checked;
		
		// Validate values
		gridRows = Math.max(1, Math.min(6, gridRows));
		gridColumns = Math.max(1, Math.min(6, gridColumns));
		refreshInterval = Math.max(0, Math.min(300, refreshInterval));
		
		// Set minimum refresh interval if enabled
		if (refreshInterval > 0 && refreshInterval < 5) {
			refreshInterval = 5;
		}
		
		// Update layout settings
		layoutSettings.autoLayout = gridType === 'auto';
		layoutSettings.gridRows = gridRows;
		layoutSettings.gridColumns = gridColumns;
		layoutSettings.showLabels = showLabels;
		layoutSettings.refreshInterval = refreshInterval;
		layoutSettings.debugMode = debugMode;
		
		// Save settings to local storage
		localStorage.setItem('layoutSettings', JSON.stringify(layoutSettings));
		
		// Return to main settings list
		showSettingsSection('settings-list-mode');
		
		// Reload webcams to apply new layout
		loadWebcams();
		
		logMessage("Layout settings saved");
	}
	
	// Show reset confirmation dialog
	function showResetConfirmation() {
		document.getElementById('reset-confirmation-dialog').classList.remove('hidden');
	}
	
	// Reset all app settings to defaults
	function resetToDefaults() {
		// Reset to default config
		webcamConfig = JSON.parse(JSON.stringify(defaultWebcamConfig));
		layoutSettings = JSON.parse(JSON.stringify(defaultLayoutSettings));
		
		// Clear localStorage
		localStorage.removeItem('webcamConfig');
		localStorage.removeItem('layoutSettings');
		
		// Close confirmation dialog
		document.getElementById('reset-confirmation-dialog').classList.add('hidden');
		
		// Return to main settings list
		showSettingsSection('settings-list-mode');
		refreshSettingsList();
		
		// Reload webcams
		loadWebcams();
		
		logMessage("Reset all settings to defaults");
	}

	// Initialize the application when DOM is loaded
	document.addEventListener('DOMContentLoaded', function() {
		try {
			console.log("[Debug] DOMContentLoaded start");

			showSplashScreen();
			console.log("[Debug] Splash screen shown");

			loadSettings();
			console.log("[Debug] Settings loaded");
			
			// Add settings button event listener
			var settingsButton = document.getElementById('settings-button');
			if (settingsButton) {
				settingsButton.addEventListener('click', openSettingsMenu);
				console.log("[Debug] Settings button event listener added");
			}

			 // Simpler approach to WebOS initialization - check if object exists and use it
			if (typeof webOS !== 'undefined') {
				console.log("[Debug] webOS object found. Setting up initialization...");
				
				// Simple initialization - either attach listener or initialize directly
				if (typeof webOS.on === 'function') {
					// Modern versions with 'ready' event
					webOS.on('ready', function() {
						console.log("[Debug] webOS ready event fired");
						initializeApp();
					});
				} else {
					// Older versions may not have 'ready' event, initialize directly
					console.log("[Debug] Using direct initialization for older webOS");
					setTimeout(function() {
						initializeApp();
					}, 500); // Small delay to let WebOS APIs become available
				}
			} else {
				// webOS object doesn't exist - critical issue
				console.error("[Debug] CRITICAL: webOS object not found at DOMContentLoaded!");
				logMessage("Error: webOS environment not detected!");
				var splashMessage = document.getElementById('splash-message');
				if (splashMessage) {
					splashMessage.textContent = "webOS API Not Available";
					splashMessage.style.color = 'red';
				}
			}

			// Fallback timer remains crucial
			console.log("[Debug] Setting 7s fallback hideSplashScreen timer...");
			setTimeout(function() {
				console.log("[Debug] 7s fallback timer fired - calling hideSplashScreen");
				hideSplashScreen(); // Force hide if still visible
			}, 7000);

			console.log("[Debug] DOMContentLoaded end");

		} catch (error) {
			console.error("[Debug] CRITICAL ERROR in DOMContentLoaded:", error);
			var splashMessage = document.getElementById('splash-message');
			if (splashMessage) {
				splashMessage.textContent = "Initialization Error!";
				splashMessage.style.color = 'red';
			}
		}
				
		// Add event listeners for all settings menu buttons
		 // Existing event listeners
		// ...existing code...

		// Settings menu buttons
		document.getElementById('settings-button').addEventListener('click', openSettingsMenu);
		document.getElementById('close-settings').addEventListener('click', closeSettingsMenu);
		document.getElementById('add-webcam-button').addEventListener('click', showAddWebcamForm);
		document.getElementById('save-new-webcam').addEventListener('click', saveNewWebcam);
		document.getElementById('cancel-add-webcam').addEventListener('click', function() {
			showSettingsSection('settings-list-mode');
		});
		document.getElementById('save-edited-webcam').addEventListener('click', saveEditedWebcam);
		document.getElementById('cancel-edit-webcam').addEventListener('click', function() {
			showSettingsSection('settings-list-mode');
		});
		document.getElementById('grid-layout-button').addEventListener('click', showGridLayoutSettings);
		document.getElementById('grid-type').addEventListener('change', updateCustomGridOptions);
		document.getElementById('save-layout-settings').addEventListener('click', saveLayoutSettings);
		document.getElementById('cancel-layout-settings').addEventListener('click', function() {
			showSettingsSection('settings-list-mode');
		});
		document.getElementById('reset-defaults-button').addEventListener('click', showResetConfirmation);
		document.getElementById('confirm-reset-btn').addEventListener('click', resetToDefaults);
		document.getElementById('cancel-reset-btn').addEventListener('click', function() {
			document.getElementById('reset-confirmation-dialog').classList.add('hidden');
		});
		document.getElementById('cancel-delete-btn').addEventListener('click', function() {
			document.getElementById('confirmation-dialog').classList.add('hidden');
		});
	});

	// Load settings from localStorage
	function loadSettings() {
		try {
			var savedWebcams = localStorage.getItem('webcamConfig');
			webcamConfig = savedWebcams ? JSON.parse(savedWebcams) : defaultWebcamConfig;
			
			var savedLayoutSettings = localStorage.getItem('layoutSettings');
			if (savedLayoutSettings) {
				layoutSettings = JSON.parse(savedLayoutSettings);
				// Ensure all required properties exist with defaults if missing
				layoutSettings.gridRows = layoutSettings.gridRows || defaultLayoutSettings.gridRows;
				layoutSettings.gridColumns = layoutSettings.gridColumns || defaultLayoutSettings.gridColumns;
				layoutSettings.autoLayout = typeof layoutSettings.autoLayout === 'boolean' ? 
					layoutSettings.autoLayout : defaultLayoutSettings.autoLayout;
				layoutSettings.showLabels = typeof layoutSettings.showLabels === 'boolean' ? 
					layoutSettings.showLabels : defaultLayoutSettings.showLabels;
				layoutSettings.refreshInterval = layoutSettings.refreshInterval || defaultLayoutSettings.refreshInterval;
			} else {
				layoutSettings = JSON.parse(JSON.stringify(defaultLayoutSettings)); // Deep copy
			}
			
			logMessage("Settings loaded successfully");
			console.log("Layout settings loaded:", layoutSettings); // Debug log
		} catch (error) {
			logMessage("Error loading settings: " + error.message);
			console.error("Error loading settings: " + error.message);
			webcamConfig = defaultWebcamConfig;
			layoutSettings = JSON.parse(JSON.stringify(defaultLayoutSettings)); // Deep copy
		}
	}

	// Save settings to local storage
	function saveSettings() {
		try {
			localStorage.setItem('webcamConfig', JSON.stringify(webcamConfig));
			logMessage("Settings saved successfully");
			return true;
		} catch (error) {
			logMessage("Error saving settings");
			console.error("Settings save error:", error);
			return false;
		}
	}
	
	// Show the splash screen
	function showSplashScreen() {
		var splashScreen = document.getElementById('splash-screen');
		splashScreen.classList.remove('hidden');
	}
	
	// Hide the splash screen
	function hideSplashScreen() {
		// *** FIX: Use correct ID 'splash-screen' ***
		var splashScreen = document.getElementById('splash-screen');
		if (splashScreen) {
			console.log("[Debug] Hiding splash screen."); // Debug log
			splashScreen.style.display = 'none';
			appLoaded = true; // Mark app as loaded
			// Focus the first webcam container if available
			var firstCamContainer = document.querySelector('.webcam-container');
			if (firstCamContainer) {
				// Ensure focus styles are applied correctly
				var currentFocused = document.querySelector('.webcam-container.focused');
				if (!currentFocused) { // Only add focus if nothing else is focused
					firstCamContainer.classList.add('focused');
					currentFocusedCam = firstCamContainer.getAttribute('data-cam-id');
					console.log("[Debug] hideSplashScreen: Setting initial focus to cam " + currentFocusedCam);
				}
			} else {
				console.log("[Debug] hideSplashScreen: No webcam containers found to focus.");
			}
		} else {
			console.error("[Debug] Splash screen element not found!"); // Debug log
		}
	}
	
	// Check if all resources have loaded
	function checkAllResourcesLoaded() {
		// Get the count of *enabled* webcams based on the current global config
		var currentEnabledWebcamCount = webcamConfig.filter(function(cam) { return cam.enabled; }).length;
		
		// *** FIX: Add more detailed logging ***
		console.log("[Debug] checkAllResourcesLoaded: appLoaded=" + appLoaded + ", attemptedStreams=" + attemptedStreams + ", loadedStreams=" + loadedStreams + ", currentEnabledWebcamCount=" + currentEnabledWebcamCount); // Debug log

		// Hide splash screen if:
		// 1. App is not already loaded AND
		// 2. EITHER no webcams are enabled OR all enabled webcams have been attempted
		if (!appLoaded && (currentEnabledWebcamCount === 0 || attemptedStreams >= currentEnabledWebcamCount)) {
			console.log("[Debug] checkAllResourcesLoaded: Conditions met, calling hideSplashScreen."); // Debug log
			hideSplashScreen();
		} else {
			console.log("[Debug] checkAllResourcesLoaded: Conditions not met."); // Debug log
		}
	}

	// Initialize clock display
	function initializeClock() {
		 // webOS object check removed - this function is now called only after webOS is ready
		logMessage("Initializing clock...");
		updateClock(); // Initial call
		clockInterval = setInterval(updateClock, 1000);
	}

	// Update clock with current time
	function updateClock() {
		// Keep the check here in case the service becomes unavailable later
		if (typeof webOS === 'undefined' || !webOS.service) {
			logMessage("webOS service lost.");
			console.error("webOS service lost during updateClock.");
			if (clockInterval) clearInterval(clockInterval); // Stop trying
			var clockElement = document.getElementById('clock');
			if (clockElement) clockElement.textContent = "Clock Lost";
			return;
		}

		webOS.service.request("luna://com.palm.systemservice", {
			method: "clock/getTime",
			parameters: {},
			onSuccess: function (args) {
				try {
					var clockElement = document.getElementById('clock');
					if (clockElement) {
						var date = new Date(args.utc * 1000);
						
						// Format time manually to avoid locale-specific prefixes
						var hours = date.getHours();
						var minutes = date.getMinutes();
						
						// Pad with leading zeros if needed
						hours = hours < 10 ? '0' + hours : hours;
						minutes = minutes < 10 ? '0' + minutes : minutes;
						
						// Create simple time string (HH:MM)
						var timeString = hours + ':' + minutes;
						
						clockElement.textContent = timeString;
					} else {
						console.error("Clock element not found in onSuccess.");
					}
				} catch (error) {
					logMessage("Error processing time.");
					console.error("Error in clock onSuccess:", error);
				}
			},
			onFailure: function (args) {
				try {
					logMessage("Failed to get time: " + args.errorText);
					console.error("Failed to get time:", args);
					var clockElement = document.getElementById('clock');
					if (clockElement) {
						clockElement.textContent = "Time Error";
					}
				} catch (error) {
					logMessage("Error handling clock failure.");
					console.error("Error in clock onFailure:", error);
				}
			}
		});
	}
</script>

<body>
	<!-- Splash Screen -->
	<div id="splash-screen" class="splash-screen">
		<div class="splash-logo">Webcam Viewer</div>
		<div class="splash-spinner"></div>
		<div id="splash-message" class="splash-message">Initializing...</div>
	</div>

	<div class="container">
		<header class="header">
			<div class="header-left">
				<div class="app-title">Webcam Viewer</div>
			</div>
			<div class="clock" id="clock">--:--</div>
			<div class="header-right">
				<button id="settings-button" class="settings-button" title="Settings">
					Settings
				</button>
			</div>
		</header>
		
		<div class="webcam-grid" id="webcam-grid">
			<!-- Webcam containers will be dynamically inserted here -->
		</div>
		
		<div class="fullscreen-mode" id="fullscreen-mode">
			<video id="fullscreen-video" class="fullscreen-feed" autoplay playsinline></video>
			<div id="fullscreen-label" class="webcam-label">Camera Name</div>
			<div class="navigation-hint">UP/DOWN: Change Camera | LEFT: Back to Grid</div>
		</div>
		
		<!-- Settings Overlay -->
		<div id="settings-overlay" class="settings-overlay">
			<div class="settings-modal">
				<div class="settings-header">
					<div class="settings-title">Webcam Settings</div>
				</div>
				<div id="settings-content" class="settings-content">
						<!-- Settings List Mode -->
						<div id="settings-list-mode" class="settings-section">
							<h3>Webcam Settings</h3>
							<div class="webcam-list" id="settings-webcam-list"></div>
							<div class="settings-buttons">
								<button id="add-webcam-button" class="btn">Add Webcam</button>
								<button id="grid-layout-button" class="btn">Grid Layout</button>
								<button id="reset-defaults-button" class="btn" style="background-color: #d9534f;">Reset to Defaults</button>
								<button id="close-settings" class="btn">Close</button>
							</div>
						</div>

						<!-- Add Webcam Mode -->
						<div id="settings-add-mode" class="settings-section hidden">
							<h3>Add New Webcam</h3>
							<div class="add-webcam-form">
								<div class="form-group">
									<label for="new-webcam-name">Name:</label>
									<input type="text" id="new-webcam-name" class="form-control">
								</div>
								<div class="form-group">
									<label for="new-webcam-url">URL:</label>
									<input type="text" id="new-webcam-url" class="form-control">
								</div>
								<div class="form-group">
									<label>
										<input type="checkbox" id="new-webcam-enabled" checked>
										Enable this webcam
									</label>
								</div>
								<div class="form-buttons">
									<button id="save-new-webcam" class="action-button">Save</button>
									<button id="cancel-add-webcam" class="action-button">Cancel</button>
								</div>
							</div>
						</div>

						<!-- Edit Webcam Mode -->
						<div id="settings-edit-mode" class="settings-section hidden">
							<h3>Edit Webcam</h3>
							<div class="add-webcam-form">
								<input type="hidden" id="edit-webcam-id">
								<div class="form-group">
									<label for="edit-webcam-name">Name:</label>
									<input type="text" id="edit-webcam-name" class="form-control">
								</div>
								<div class="form-group">
									<label for="edit-webcam-url">URL:</label>
									<input type="text" id="edit-webcam-url" class="form-control">
								</div>
								<div class="form-group">
									<label>
										<input type="checkbox" id="edit-webcam-enabled">
										Enable this webcam
									</label>
								</div>
								<div class="form-buttons">
									<button id="save-edited-webcam" class="action-button">Save</button>
									<button id="cancel-edit-webcam" class="action-button">Cancel</button>
								</div>
							</div>
						</div>

						<!-- Grid Layout Mode -->
						<div id="settings-grid-layout-mode" class="settings-section hidden">
							<h3>Grid Layout Settings</h3>
							<div class="form-group">
								<label for="grid-type">Grid Type:</label>
								<select id="grid-type" class="form-control">
									<option value="auto">Auto (Dynamic)</option>
									<option value="custom">Custom Grid</option>
								</select>
							</div>
							<div class="form-group" id="custom-grid-options">
								<label for="grid-rows">Rows:</label>
								<input type="number" id="grid-rows" class="form-control" min="1" max="6" value="2">
								<label for="grid-columns">Columns:</label>
								<input type="number" id="grid-columns" class="form-control" min="1" max="6" value="2">
							</div>
							<div class="form-group">
								<label for="show-labels">Show Camera Labels:</label>
								<input type="checkbox" id="show-labels" checked>
							</div>
							<div class="form-group">
								<label for="auto-refresh">Auto-refresh Interval (seconds):</label>
								<input type="number" id="auto-refresh" class="form-control" min="0" max="300" value="0">
								<small>0 = disabled, min 5 seconds if enabled</small>
							</div>
							<div class="form-group">
								<label for="debug-mode">Enable Debug Logging:</label>
								<input type="checkbox" id="debug-mode">
								<small>Show detailed logs in the UI</small>
							</div>
							<div class="settings-buttons">
								<button id="save-layout-settings" class="btn">Save</button>
								<button id="cancel-layout-settings" class="btn">Cancel</button>
							</div>
						</div>
				</div>
				<div class="settings-footer">
					<button id="close-settings" class="action-button" onclick="closeSettingsMenu()">Close</button>
				</div>
			</div>
		</div>
		
		<!-- Custom confirmation dialog -->
		<div id="confirmation-dialog" class="confirmation-dialog hidden">
			<div class="confirmation-dialog-content">
				<div class="confirmation-dialog-header">Confirm Delete</div>
				<div class="confirmation-dialog-body">
					Are you sure you want to delete <span id="delete-webcam-name"></span>?
				</div>
				<div class="confirmation-dialog-footer">
					<button id="confirm-delete-btn" class="action-button delete">Delete</button>
					<button id="cancel-delete-btn" class="action-button">Cancel</button>
				</div>
			</div>
		</div>

		<!-- Reset confirmation dialog -->
		<div id="reset-confirmation-dialog" class="confirmation-dialog hidden">
			<div class="confirmation-dialog-content">
				<div class="confirmation-dialog-header">Reset to Default Settings</div>
				<div class="confirmation-dialog-body">
					<p>This will reset all app settings to their default values:</p>
					<ul style="text-align: left; margin-top: 10px; margin-bottom: 10px;">
						<li>All custom webcam configurations will be removed</li>
						<li>Default sample webcams will be restored</li>
						<li>Grid layout will be reset to Auto (2×2)</li>
						<li>All preferences will be reset</li>
					</ul>
					<p>Are you sure you want to continue?</p>
				</div>
				<div class="confirmation-dialog-footer">
					<button id="confirm-reset-btn" class="action-button delete">Reset Everything</button>
					<button id="cancel-reset-btn" class="action-button">Cancel</button>
				</div>
			</div>
		</div>

		<div class="log-box" id="log-box">
			<!-- Log messages will appear here -->
		</div>
	</div>
</body>

</html>
